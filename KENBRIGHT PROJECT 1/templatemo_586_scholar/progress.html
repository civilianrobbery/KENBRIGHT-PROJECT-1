<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="theme-color" content="#ffffff">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css2?family=Gill+Sans+Nova:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <title>My Progress | Kenbright IFRS 17 Training</title>
    
    <!-- CSS Files -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    <link rel="stylesheet" href="assets/css/templatemo-scholar.css">
    <link rel="stylesheet" href="assets/css/modules.css">
    <style>
        /* Apply Gill Sans font to entire page */
        body {
            font-family: 'Gill Sans Nova', 'Gill Sans', sans-serif;
            font-size: 20px;
            line-height: 1.6;
            background: #f8f9fa;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Gill Sans Nova', 'Gill Sans', sans-serif;
            font-weight: 600;
        }
        
        /* Header styling - matching module-5.html */
        .header-area {
            padding: 0 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .main-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 0;
        }

        .main-nav .nav {
            display: flex;
            gap: 20px;
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .main-nav .nav li a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
            font-family: 'Gill Sans Nova', 'Gill Sans', sans-serif;
            font-size: 18px;
        }

        .main-nav .nav li a:hover {
            color: #3B82F6;
        }

        /* Search input styling */
        .search-input {
            flex: 1;
            max-width: 400px;
            margin: 0 20px;
            position: relative;
        }

        .search-input input {
            width: 100%;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-family: 'Gill Sans Nova', 'Gill Sans', sans-serif;
            font-size: 18px;
        }

        .search-input i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }

        /* Logo Styles */
        .logo-image {
            height: 130px;
            width: auto;
            max-width: 500px;
        }

        /* Banner */
        .main-banner {
            background: linear-gradient(135deg, #0F172A 0%, #1E3A8A 50%, #2563EB 100%);
            padding: 100px 0px 60px 0px;
            margin-bottom: 40px;
        }

        .main-banner .header-text h2 {
            color: #fff !important;
            font-family: 'Gill Sans Nova', 'Gill Sans', sans-serif;
            font-size: 42px;
            margin-bottom: 10px;
        }
        
        .main-banner .header-text p {
            color: #E2E8F0 !important;
            font-family: 'Gill Sans Nova', 'Gill Sans', sans-serif;
            font-size: 22px;
            opacity: 0.9;
        }

        /* Progress Dashboard */
        .progress-dashboard {
            padding: 0 0 60px 0;
        }

        /* Progress Cards */
        .progress-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
            height: 100%;
            border-top: 5px solid;
        }

        .progress-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .progress-card h3 {
            font-size: 42px;
            font-weight: 700;
            margin: 15px 0 10px 0;
            color: #2c3e50;
        }

        .progress-card p {
            color: #666;
            font-size: 18px;
            margin: 0;
        }

        .progress-icon {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .card-modules { border-top-color: #667eea; }
        .card-modules .progress-icon { color: #667eea; }

        .card-progress { border-top-color: #14B8A6; }
        .card-progress .progress-icon { color: #14B8A6; }

        .card-score { border-top-color: #ffc107; }
        .card-score .progress-icon { color: #ffc107; }

        .card-time { border-top-color: #dc3545; }
        .card-time .progress-icon { color: #dc3545; }

        /* Progress Bar Section */
        .progress-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .progress-section h4 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-section h4 i {
            color: #667eea;
        }

        .overall-progress {
            margin-bottom: 20px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 18px;
            color: #666;
        }

        .progress-bar {
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 1s ease-in-out;
        }

        /* Module Progress List */
        .module-progress-list {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .module-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }

        .module-item:hover {
            background: #f1f3f4;
            transform: translateX(5px);
        }

        .module-item.completed {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .module-item.in-progress {
            border-left-color: #ffc107;
            background: #fffcf0;
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .module-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 20px;
        }

        .module-progress {
            font-weight: 600;
            font-size: 18px;
        }

        .module-progress.high { color: #28a745; }
        .module-progress.medium { color: #ffc107; }
        .module-progress.low { color: #dc3545; }

        .module-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }

        .module-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease;
        }

        .module-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-module {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-family: 'Gill Sans Nova', 'Gill Sans', sans-serif;
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-continue {
            background: #667eea;
            color: white;
        }

        .btn-continue:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-assessment {
            background: transparent;
            border: 2px solid #14B8A6;
            color: #14B8A6;
        }

        .btn-assessment:hover {
            background: #14B8A6;
            color: white;
        }

        /* Recent Assessments */
        .assessments-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .assessment-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid;
        }

        .assessment-item.pass {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .assessment-item.fail {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .assessment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .assessment-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 18px;
        }

        .assessment-score {
            font-weight: 700;
            font-size: 20px;
        }

        .assessment-score.pass { color: #28a745; }
        .assessment-score.fail { color: #dc3545; }

        .assessment-details {
            display: flex;
            gap: 20px;
            color: #666;
            font-size: 16px;
            margin-top: 10px;
        }

        .assessment-details i {
            margin-right: 5px;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Footer */
        footer {
            background: #0F172A;
            color: white;
            padding: 30px 0;
            margin-top: 50px;
        }

        footer p {
            font-size: 18px;
            margin: 0;
            text-align: center;
            font-family: 'Gill Sans Nova', 'Gill Sans', sans-serif;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                font-size: 18px;
            }
            
            .main-banner .header-text h2 {
                font-size: 32px;
            }
            
            .main-banner .header-text p {
                font-size: 18px;
            }
            
            .progress-card h3 {
                font-size: 36px;
            }
            
            .logo-image {
                height: 35px;
                max-width: 150px;
            }
            
            .main-nav {
                flex-direction: column;
                gap: 15px;
            }
            
            .search-input {
                max-width: 100%;
                margin: 10px 0;
            }
            
            .module-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .assessment-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>

<body>

  <!-- Header Area -->
  <header class="header-area header-sticky">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav class="main-nav">
                    <!-- Logo -->
                    <a href="index.html" class="logo">
                        <img src="assets/images/kenbright-logo.png" alt="Kenbright" class="logo-image">
                    </a>
                    
                    <!-- Search -->
                    <div class="search-input">
                        <form id="search" action="#">
                            <input type="text" placeholder="Search IFRS 17 concepts..." id='searchText' name="searchKeyword" />
                            <i class="fa fa-search"></i>
                        </form>
                    </div>
                    
                    <!-- Main Navigation -->
                    <ul class="nav">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="modules.html">Training Modules</a></li>
                        <li><a href="assessments.html">Test Assessments</a></li>
                        <li><a href="progress.html" class="active">My Progress</a></li>
                    </ul>

                    <!-- Account Navigation -->
                    <ul class="nav" id="account-nav">
                        <!-- Will be populated by auth.js -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
  </header>

  <!-- Page Banner -->
  <div class="main-banner" id="top">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="header-text">
            <h2>My Learning Progress</h2>
            <p>Track your advancement through the IFRS 17 training curriculum</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Dashboard -->
  <section class="progress-dashboard">
    <div class="container">
      <!-- Loading Overlay -->
      <div id="loadingOverlay" style="display: none;">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Loading your progress data...</p>
        </div>
      </div>

      <!-- Progress Overview Cards -->
      <div class="row g-4 mb-4">
        <div class="col-lg-3 col-md-6">
          <div class="progress-card card-modules">
            <div class="progress-icon">
              <i class="fa fa-book"></i>
            </div>
            <h3 id="completedModules">0</h3>
            <p>Modules Completed</p>
            <small id="totalModulesText">of 15 total</small>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="progress-card card-progress">
            <div class="progress-icon">
              <i class="fa fa-chart-line"></i>
            </div>
            <h3 id="overallProgress">0%</h3>
            <p>Overall Progress</p>
            <small>Course Completion</small>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="progress-card card-score">
            <div class="progress-icon">
              <i class="fa fa-star"></i>
            </div>
            <h3 id="averageScore">0%</h3>
            <p>Average Score</p>
            <small>Assessment Performance</small>
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <div class="progress-card card-time">
            <div class="progress-icon">
              <i class="fa fa-clock"></i>
            </div>
            <h3 id="timeSpent">0</h3>
            <p>Hours Spent</p>
            <small>Learning Time</small>
          </div>
        </div>
      </div>

      <!-- Overall Progress Bar -->
      <div class="progress-section">
        <h4><i class="fa fa-tasks"></i> Overall Course Progress</h4>
        <div class="overall-progress">
          <div class="progress-bar">
            <div class="progress-fill" id="overallProgressBar" style="width: 0%"></div>
          </div>
          <div class="progress-text">
            <span>Starting Point</span>
            <span id="progressPercentage">0%</span>
            <span>Course Complete</span>
          </div>
        </div>
        <div class="mt-3">
          <p id="progressDescription">You're just getting started! Begin with Module 1 to make progress.</p>
        </div>
      </div>

      <!-- Module Progress -->
      <div class="module-progress-list">
        <h4><i class="fa fa-graduation-cap"></i> Module Progress</h4>
        <p class="text-muted mb-4">Track your completion and scores for each module</p>
        
        <div id="moduleList">
          <!-- Modules will be loaded here -->
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading modules...</span>
            </div>
            <p class="mt-2">Loading your module progress...</p>
          </div>
        </div>
      </div>

      <!-- Recent Assessments -->
      <div class="assessments-section">
        <h4><i class="fa fa-clipboard-check"></i> Recent Assessment Results</h4>
        <p class="text-muted mb-4">Your latest assessment performances</p>
        
        <div id="assessmentsList">
          <!-- Assessments will be loaded here -->
          <div class="text-center py-3">
            <p>No assessment results yet.</p>
            <a href="assessments.html" class="btn btn-primary">Take an Assessment</a>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="text-center mt-5">
        <div class="btn-group" role="group">
          <a href="modules.html" class="btn btn-primary btn-lg">
            <i class="fa fa-play-circle"></i> Continue Learning
          </a>
          <a href="assessments.html" class="btn btn-outline-primary btn-lg">
            <i class="fa fa-clipboard-list"></i> Take Assessment
          </a>
          <button onclick="refreshProgress()" class="btn btn-outline-secondary btn-lg">
            <i class="fa fa-sync-alt"></i> Refresh Progress
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="col-lg-12">
        <p>Copyright Â© <span id="currentYear">2025</span> Kenbright IFRS 17 Training Platform. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/progress.js"></script>
  <script>
    // Update copyright year
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    // Check authentication on page load
    window.addEventListener('load', () => {
      if (!authManager.isAuthenticated()) {
        window.location.href = 'login.html';
        return;
      }
      
      // Load progress data
      loadProgressData();
    });

    // Function to refresh progress data
    function refreshProgress() {
      loadProgressData();
      showMessage('Progress data refreshed!', 'success');
    }

    // Show message function
    function showMessage(message, type = 'info') {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show fixed-top mx-3 mt-5`;
      alert.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      `;
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(alert);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, 5000);
    }

    // Load progress data from backend
    async function loadProgressData() {
      try {
        const token = authManager.getAuthToken();
        
        if (!token) {
          window.location.href = 'login.html';
          return;
        }

        // Show loading
        document.getElementById('loadingOverlay').style.display = 'block';
        
        const response = await fetch('http://localhost:3000/api/progress', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) {
          throw new Error('Failed to load progress data');
        }
        
        const data = await response.json();
        
        // Update overview cards
        document.getElementById('completedModules').textContent = data.completedModules;
        document.getElementById('totalModulesText').textContent = `of ${data.totalModules} total`;
        document.getElementById('overallProgress').textContent = data.overallProgress + '%';
        document.getElementById('averageScore').textContent = data.averageScore + '%';
        document.getElementById('timeSpent').textContent = data.timeSpent;
        
        // Update progress bar
        const progressBar = document.getElementById('overallProgressBar');
        progressBar.style.width = data.overallProgress + '%';
        document.getElementById('progressPercentage').textContent = data.overallProgress + '%';
        
        // Update progress description
        const progressDesc = document.getElementById('progressDescription');
        if (data.overallProgress === 0) {
          progressDesc.textContent = "You're just getting started! Begin with Module 1 to make progress.";
        } else if (data.overallProgress < 50) {
          progressDesc.textContent = "Great start! Keep going to reach the halfway point.";
        } else if (data.overallProgress < 100) {
          progressDesc.textContent = "You're making excellent progress! Complete the remaining modules.";
        } else {
          progressDesc.textContent = "Congratulations! You've completed the entire IFRS 17 training curriculum.";
        }
        
        // Update module list
        updateModuleList(data.modules);
        
        // Update assessments list
        updateAssessmentsList(data.assessments);
        
        // Hide loading
        document.getElementById('loadingOverlay').style.display = 'none';
        
      } catch (error) {
        console.error('Error loading progress:', error);
        document.getElementById('loadingOverlay').style.display = 'none';
        showMessage('Error loading progress data. Please try again.', 'danger');
      }
    }

    // Update module list
    function updateModuleList(modules) {
      const moduleList = document.getElementById('moduleList');
      
      if (!modules || modules.length === 0) {
        moduleList.innerHTML = `
          <div class="text-center py-4">
            <p class="text-muted">No module progress data available.</p>
            <a href="modules.html" class="btn btn-primary">Start Learning</a>
          </div>
        `;
        return;
      }
      
      // Get module titles
      fetch('http://localhost:3000/api/progress/modules/titles')
        .then(response => response.json())
        .then(titles => {
          let html = '';
          
          modules.forEach(module => {
            const progress = module.progress || 0;
            const isCompleted = module.completed || progress >= 100;
            const score = module.score || 0;
            const title = titles[module.module_id] || `Module ${module.module_id}`;
            
            let progressClass = 'low';
            if (progress >= 80) progressClass = 'high';
            else if (progress >= 50) progressClass = 'medium';
            
            let fillColor = '#dc3545';
            if (progress >= 80) fillColor = '#28a745';
            else if (progress >= 50) fillColor = '#ffc107';
            
            html += `
              <div class="module-item ${isCompleted ? 'completed' : 'in-progress'}">
                <div class="module-header">
                  <div class="module-title">${title}</div>
                  <div class="module-progress ${progressClass}">${progress}%</div>
                </div>
                <div class="module-bar">
                  <div class="module-fill" style="width: ${progress}%; background: ${fillColor};"></div>
                </div>
                <div class="module-actions">
                  <a href="module-${module.module_id}.html" class="btn-module btn-continue">
                    ${progress === 0 ? 'Start' : 'Continue'} Learning
                  </a>
                  <a href="assessment-${module.module_id}.html" class="btn-module btn-assessment">
                    Take Assessment
                  </a>
                </div>
              </div>
            `;
          });
          
          moduleList.innerHTML = html;
        })
        .catch(error => {
          console.error('Error loading module titles:', error);
        });
    }

    // Update assessments list
    function updateAssessmentsList(assessments) {
      const assessmentsList = document.getElementById('assessmentsList');
      
      if (!assessments || assessments.length === 0) {
        assessmentsList.innerHTML = `
          <div class="text-center py-3">
            <p class="text-muted">No assessment results yet.</p>
            <a href="assessments.html" class="btn btn-primary">Take an Assessment</a>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      assessments.forEach(assessment => {
        const isPass = assessment.score >= 70;
        const date = new Date(assessment.taken_at).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
        
        html += `
          <div class="assessment-item ${isPass ? 'pass' : 'fail'}">
            <div class="assessment-header">
              <div class="assessment-title">${assessment.moduleTitle || `Module ${assessment.module_id}`}</div>
              <div class="assessment-score ${isPass ? 'pass' : 'fail'}">${assessment.score}%</div>
            </div>
            <div class="assessment-details">
              <span><i class="fa fa-calendar"></i> ${date}</span>
              <span><i class="fa fa-question-circle"></i> ${assessment.total_questions} questions</span>
              <span><i class="fa fa-check-circle"></i> ${assessment.correct_answers} correct</span>
              ${assessment.time_spent ? `<span><i class="fa fa-clock"></i> ${assessment.time_spent}</span>` : ''}
            </div>
            ${assessment.feedback ? `<div class="mt-2"><small><strong>Feedback:</strong> ${assessment.feedback}</small></div>` : ''}
          </div>
        `;
      });
      
      assessmentsList.innerHTML = html;
    }
  </script>
</body>
</html>